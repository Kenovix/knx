{% extends "::admin_layout.html.twig" %}

{% block menu %}
	{{ knp_menu_render('ParametrizarBundle:Builder:superAdminMenu') }}
{% endblock %}

{% block rastro %}{{ wo_render_breadcrumbs() }}{% endblock %}

{% block titulo %}Nueva factura{% endblock %}

{% block msg %}
	{% if app.session.hasFlash('ok') %}
	    <div class="alert alert-success">
	    	<button data-dismiss="alert" class="close" type="button">×</button>
	        <span>{{ app.session.flash('ok') }}</span>
	    </div>
	{% elseif app.session.hasFlash('info') %}
		<div class="alert alert-info">
	    	<button data-dismiss="alert" class="close" type="button">×</button>
	        <span>{{ app.session.flash('info') }}</span>
	    </div>
	{% elseif app.session.hasFlash('error') %}
		<div class="alert alert-error">
	    	<button data-dismiss="alert" class="close" type="button">×</button>
	        <span>{{ app.session.flash('error') }}</span>
	    </div>
	{% endif %}
{% endblock %}

{% block cuerpo %}

	<form action="#" class="form-horizontal" method="post" {{ form_enctype(form) }}>
	    <fieldset>
	    	<legend>Datos del paciente</legend>
	    	
	    	<div class="control-group">
	    		<label class="control-label required" for="tipoid">Identificaci&oacute;n</label>
	    		<div class="controls">
	    			<select class="span1" required="required" name="tipoid" id="tipoid">
	    				<option value="RC">RC</option>
	    				<option value="TI">TI</option>
	    				<option value="CE">CE</option>
	    				<option value="CC" selected="selected">CC</option>
	    			</select>
	    			
	    			<div class="input-append">
	    				<input class="span6" type="text" name="identificacion" id="identificacion" placeholder="identificación" />
    					<button id="buscar_paciente" class="btn" type="button">Buscar</button>
    					
    				</div>
    				<span id="msg" class="label"></span>	
	   
	    		</div>
	    	</div>
	    	
	    	<div id="datos-paciente"></div>
	    	
	    	<div class="control-group">
	    		<label class="control-label required" for="tipoid">{{ form_label(form.cliente) }}</label>
	    		<div class="controls">	    			
	            	{{ form_errors(form.cliente) }}
	            	{{ form_widget(form.cliente) }}
	            	
	            	{% ui_button onclick="myDialog.wijdialog('open');" value="Open"%}
	            	 
	    		</div>
	    	</div>
	    	  
			{% ui_dialog id="myDialogId"
			             title="Hello World"
			             widgetVar="myDialog"
			             autoOpen=false
			             modal=true
			%}
			
				Hello World
			    
			{% end_ui_dialog %} 
	    	
		</fieldset>
		
		<fieldset>
	    	<legend>Datos del paciente</legend>	    	
	    	    
			{{ form_rest(form) }}
		</fieldset>
		
		<div class="form-actions">
			<input class="btn btn-primary" name="guardar" type="submit" value="Guardar" />
		    <a href="{{ path('parametrizar_index') }}" class="btn btn-danger">Cancelar</a>
		</div>
	</form>
{% endblock %}

{% block javascripts %}
	<script type="text/javascript">

		$("#buscar_paciente").click(function(){
				        
	        var tipoid = $("#tipoid").val();
	        var identificacion = $("#identificacion").val();

	        $("#msg").empty();
	        
	    	if($.isNumeric(identificacion)){

	    		$("#buscar_paciente").attr('disabled', 'disabled');
	
	    		var url="{{ path('facturacion_paciente_buscar') }}";
	
	    		$.post(url,{
	    			tipoid: tipoid,
	    			identificacion: identificacion
		         },function(data){
		             if(data.responseCode==200 ){

			            $("#msg").removeClass("label-important");
		            	$("#msg").addClass("label-success");
						$("#msg").html("Creado el "+data.paciente.nombre);

						var select = $('#Cupo_cliente');
                		if(select.prop) {
                		  var options = select.prop('options');
                		}
                		else {
                		  var options = select.attr('options');
                		}
                		$('option', select).remove();

                	    if(data.cliente){
                	    	options[options.length] = new Option('Seleccione aseguradora', '');

                    	}else{
                    		options[options.length] = new Option('--', '');
                        }

                		$.each(data.cliente, function(val, text) {
                		    options[options.length] = new Option(text, val);
                		});

                		select.val('');
		             }
		             else if(data.responseCode==400){

			            $("#msg").removeClass("label-success");
						$("#msg").addClass("label-important");
						$("#msg").html("El paciente con "+tipoid+" número "+identificacion+" no existe en la base de datos, verifique datos e intente nuevamente.");						
		             }
		             else{
		         	    alert("Ha ocurrido un error en el sistema.");
		             }
		      	});

	    		$("#buscar_paciente").removeAttr('disabled');
		    }else{
			    alert("Por favor ingrese un valor valido.");
			}
		});
	</script>		
	
{% endblock %}